---
title: "Win Detection"
description: "Detect when the game ends, count territories, and declare a winner."
pubDate: 2026-01-04
game: 1
gameName: "Ink War"
unit: 9
totalUnits: 16
system: "Sinclair ZX Spectrum"
tags: ["assembly", "z80", "game-logic", "state"]
nextLesson: "/sinclair-zx-spectrum/assembly/game-01-ink-war/unit-10"
layout: "../../../../layouts/UnitLayout.astro"
---

import CodeFromFile from "@components/CodeFromFile.astro";

*Need to catch up? Check out [Unit 8: Better AI](/sinclair-zx-spectrum/game-01-ink-war/unit-08).*

## What You're Building

The game plays, but it never ends. You keep claiming until the board fills up, then... nothing. Time to fix that.

By the end of this unit, you'll have:

- Detection for when the board is full
- Territory counting for both players
- A winner announcement
- A game-over state that waits for restart

![Game over screen showing the winner](/images/sinclair-zx-spectrum/game-01-ink-war/unit-09/screenshot.png)

## When Does the Game End?

The game ends when no valid moves remain. This happens when:
1. The board is completely full (all 64 cells claimed), OR
2. Neither player can make a valid move (both are blocked)

We'll track remaining moves with a simple counter. Starting at 62 (64 cells minus 2 starting cells), it decrements after each claim. When it hits zero, we check the winner.

## The Plan

We need:

1. **A move counter** to track remaining cells
2. **Territory counting** to see who has more
3. **A game-over routine** to display the winner
4. **A restart mechanism** to play again

## Tracking Remaining Moves

Add a variable to count unclaimed cells:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/01-tracking-remaining-moves.asm" lang="asm" />

Decrement it whenever a cell is claimed:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/02-tracking-remaining-moves.asm" lang="asm" />

The AI also claims cells, so we decrement there too:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/03-tracking-remaining-moves.asm" lang="asm" />

## Counting Territories

When the game ends, we count how many cells each player owns:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/04-counting-territories.asm" lang="asm" />

This is simpler than the nested loops we used for AI scanning — we just walk through the 64-byte array linearly.

## Checking the Winner

After counting, compare the totals:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/05-checking-the-winner.asm" lang="asm" />

**`cp b` then `jr c`** — After comparing A with B, carry is set if A < B. So if P2's count is less than P1's count, P1 wins.

## Displaying the Result

We need to show who won. The Spectrum ROM has a print routine at address 8252 (decimal) that we can use, but for simplicity let's write directly to the attribute memory with coloured blocks:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/06-displaying-the-result.asm" lang="asm" />

This flashes the border rapidly to signal game over, then settles on the winner's colour.

## Waiting for Restart

After showing the result, we wait for the player to press SPACE:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/07-waiting-for-restart.asm" lang="asm" />

We first wait for SPACE to be released (in case it was held from claiming the last cell), then wait for a new press.

## Restarting the Game

Reset everything to initial state:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/snippets/08-restarting-the-game.asm" lang="asm" />

**`jp main_loop`** — Unlike `call`, `jp` doesn't push a return address. We're not returning; we're starting fresh.

## Integrating with the Game

The key integration points:

1. **After human claims**: Decrement counter, check for game over
2. **After AI claims**: Same — decrement and check
3. **Game over flow**: Count → show result → wait → restart

## Build It. Run It.

```bash
pasmo --tapbas inkwar.asm inkwar.tap
```

Load the tape and play a full game. When the board fills:

- The border should flash rapidly
- It settles on the winner's colour (red, cyan, or yellow for draw)
- Pressing SPACE restarts to a fresh game

## Recap / Sanity Check

- Game over triggers when `moves_remaining` hits 0
- Territory counts reflect actual board state
- Border flashing signals game end clearly
- SPACE restarts to a clean game
- All state resets: board, cursor, counter, player

## What You've Built

Look at what changed from Unit 8:

- **`moves_remaining`** — Tracks unclaimed cells
- **`count_territories`** — Sums cells per player
- **`check_game_over`** — Determines the winner
- **`show_game_over`** — Visual feedback for game end
- **`wait_for_restart`** — Waits for player input
- **`restart_game`** — Resets all state

The game now has a proper beginning, middle, and end!

## What You've Learnt

- **Game state tracking** — A simple counter detects end-of-game
- **Linear array scanning** — Walking through memory without nested loops
- **Comparison and branching** — Using carry flag for less-than comparisons
- **State reset** — Clearing everything for a fresh start
- **`jp` vs `call`** — Jump when you don't need to return

## The Complete Code

Here's `inkwar.asm` as it stands after Unit 9:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-09/inkwar.asm" lang="asm" />

## Next Unit

The game ends, but the ending is sparse. Just a coloured border? We can do better.

In Unit 10, we'll add **Scoring** — displaying the final counts and making the victory screen more informative.
