---
title: "Turn Logic"
description: "Implement two-player turns with visual feedback. Learn XOR tricks and use the border as a turn indicator."
pubDate: 2026-01-03
game: 1
gameName: "Ink War"
unit: 5
totalUnits: 16
system: "Sinclair ZX Spectrum"
tags: ["assembly", "z80", "turn-logic", "game-state"]
nextLesson: "/sinclair-zx-spectrum/assembly/game-01-ink-war/unit-06"
layout: "../../../../layouts/UnitLayout.astro"
---

import CodeFromFile from "@components/CodeFromFile.astro";

*Need to catch up? Check out [Unit 4: Claiming Cells](/sinclair-zx-spectrum/game-01-ink-war/unit-04).*

## What You're Building

Right now both players paint in the same colour. That's no war — that's interior decorating.

By the end of this unit, you'll have:

- Two players taking alternating turns
- The border colour showing whose turn it is
- Automatic player swap after each claim
- A real two-player game (pass the keyboard!)

![Two-player game with turn indicator](/images/sinclair-zx-spectrum/game-01-ink-war/unit-05/screenshot.png)

## The XOR Trick

We already have `current_player` from Unit 4. Now we need to toggle it between 1 and 2. There's a classic bit manipulation trick for this:

```
Player 1 = %01
Player 2 = %10

XOR with %11 (which is 3):
  %01 XOR %11 = %10  (1 becomes 2)
  %10 XOR %11 = %01  (2 becomes 1)
```

Why does this work? XOR flips bits where the mask has 1s. Since 3 = %11, it flips both low bits. This happens to toggle between the values 1 and 2. One instruction, no branches, no comparisons.

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-05/snippets/01-the-xor-trick.asm" lang="asm" />

**`xor 3`** — "Exclusive OR A with 3." XOR compares bits: if they're different, the result is 1; if they're the same, the result is 0. When you XOR with a value, you flip the bits where that value has 1s.

| A before | 3 (%11) | A after |
|----------|---------|---------|
| 1 (%01)  | XOR     | 2 (%10) |
| 2 (%10)  | XOR     | 1 (%01) |

This trick only works because we chose 1 and 2 as our player numbers. If we'd used 0 and 1, we'd need `xor 1` instead.

## Visual Feedback

How does a player know it's their turn? The Spectrum's border is perfect for this — always visible, easy to change, and we've already used `out (254), a` to set it black.

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-05/snippets/02-visual-feedback.asm" lang="asm" />

Red border = Player 1's turn. Cyan border = Player 2's turn. No text needed, no screen space wasted.

## Integrating with Claiming

The `claim_cell` routine from Unit 4 needs to call `swap_player` after a successful claim. Here's the updated version:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-05/snippets/03-integrating-with-claiming.asm" lang="asm" />

The key change: we call `swap_player` after successfully claiming. This toggles `current_player` and updates the border.

## Initialising the Turn

At startup, we need to set the border to Player 1's colour:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-05/snippets/04-initialising-the-turn.asm" lang="asm" />

Without this, the border would start black (from `clear_screen`), leaving players confused about whose turn it is.

## The Game Flow

Here's what happens now:

1. **Game starts**: Border is RED (Player 1)
2. **Player 1** moves cursor with Q/A/O/P
3. **Player 1** presses SPACE on an empty cell
4. Cell turns RED, border changes to CYAN
5. **Player 2** moves cursor (same keys — pass the keyboard!)
6. **Player 2** presses SPACE on an empty cell
7. Cell turns CYAN, border changes to RED
8. **Repeat** until board is full

Two players, one keyboard, no rules about *where* you can claim. We'll add territory restrictions in Unit 6.

## Build It. Run It.

```bash
pasmo --tapbas inkwar.asm inkwar.tap
```

Load the tape in your emulator. You should see:

- Border starts RED
- Claim a cell — it turns red, border goes CYAN
- Claim another cell — it turns cyan, border goes RED
- Keep alternating!

## Recap / Sanity Check

- Border should change colour after every successful claim
- Claiming an already-owned cell does nothing (no player swap)
- Both players use the same controls (Q/A/O/P/SPACE)
- If the border doesn't change, check that `swap_player` is being called
- If cells don't change colour, check `set_cell_colour`

## What You've Built

Look at what changed from Unit 4:

- **`swap_player`** — Toggles between players using XOR
- **`update_ui_colours`** — Updates border to show current player
- **Modified `claim_cell`** — Now calls `swap_player` after claiming
- **Initial setup** — Calls `update_ui_colours` at startup

The game is now truly two-player. Pass the keyboard to your opponent!

## What You've Learnt

- **XOR for toggling** — `xor 3` swaps between 1 and 2
- **Visual feedback** — The border communicates game state instantly
- **State management** — One byte (`current_player`) controls game flow
- **Integration** — New features plug into existing routines

## The Complete Code

Here's `inkwar.asm` as it stands after Unit 5:

<CodeFromFile src="sinclair-zx-spectrum/game-01-ink-war/unit-05/inkwar.asm" lang="asm" />

## Next Unit

Players can claim any cell they want. That's not much of a territory war.

In Unit 6, we'll implement **Valid Moves** — you can only claim cells adjacent to territory you already own. This transforms random clicking into actual strategy.
