---
title: "The Traffic"
description: "Introduce the Blitter. Learn how to set up bitplanes and use the Blitter to draw cars on the road."
pubDate: 2026-01-03
game: 1
gameName: "Hop"
unit: 4
totalUnits: 16
system: "Commodore Amiga"
tags: ["assembly", "68000", "blitter", "bitplanes"]
nextLesson: "/commodore-amiga/assembly/game-01-signal/unit-05"
layout: "../../../../layouts/UnitLayout.astro"
---

import CodeFromFile from "@components/CodeFromFile.astro";

*Need to catch up? Check out [Unit 3: The Hop](/commodore-amiga/game-01-signal/unit-03).*

## What You're Building

The frog has a nice road, but it's empty. Time to make it dangerous.

By the end of this unit, you'll have:

- A bitmap screen layer using bitplanes
- A car drawn using the Blitter
- Understanding of planar graphics and the Blitter's operation

## The Problem with Hardware Sprites

We only have 8 hardware sprites, and the frog uses one. We could use a few more for cars, but what about logs, turtles, and all the traffic in a busy Frogger game? We need more drawing power.

Enter the **Blitter** (Block Image Transferrer) — dedicated hardware that copies rectangular blocks of memory faster than the CPU.

## Bitplanes: Amiga's Screen Memory

Amiga graphics are **planar**, not chunky. Instead of storing all bits for each pixel together, we store separate "planes" of bits:

| Planes | Colours | Bits per pixel |
|--------|---------|----------------|
| 1 | 2 | 1 |
| 2 | 4 | 2 |
| 3 | 8 | 3 |
| 4 | 16 | 4 |
| 5 | 32 | 5 |

For Hop, we'll use **2 bitplanes** (4 colours). That's enough for cars: transparent, body, detail, outline.

### Screen Memory Layout

A 320-pixel-wide screen uses 40 bytes per line (320 ÷ 8). For 256 lines:

```
Bytes per plane = 40 × 256 = 10,240 bytes
Total for 2 planes = 20,480 bytes
```

This must be in **chip RAM** — memory accessible by the custom chips.

## Setting Up Bitplanes

We need to:

1. **Allocate screen memory** in chip RAM
2. **Configure BPLCON0** to enable bitplanes
3. **Set bitplane pointers** so hardware knows where screen data lives
4. **Enable bitplane DMA** in DMACON

### BPLCON0 — Bitplane Control

Register $100 controls the display:

| Bits | Purpose |
|------|---------|
| 15 | High resolution mode |
| 14-12 | Number of bitplanes (BPU) |
| 11 | Hold-and-modify (HAM) |
| 9 | Dual playfield |
| 1 | Colour enable |

For 2 bitplanes with colour: `$2200` (BPU=2, colour on)

### Bitplane Pointers

Each plane needs its address set via two registers:

| Plane | High | Low |
|-------|------|-----|
| 1 | $0E0 (BPL1PTH) | $0E2 (BPL1PTL) |
| 2 | $0E4 (BPL2PTH) | $0E6 (BPL2PTL) |

We'll put placeholders in the copper list and have the CPU fill them in.

## The Blitter

The Blitter has four channels (A, B, C, D) that combine data using boolean logic:

- **A** — Usually the mask (shape)
- **B** — Usually the source graphics
- **C** — Background (read before write)
- **D** — Destination (write result)

The operation is defined by an 8-bit **minterm** that specifies the boolean combination. For a simple copy (A=mask, B=source, C=dest):

```
D = (A AND B) OR (NOT A AND C)
```

This "cookies out" the shape: where the mask is 1, take the source; where 0, keep the background.

### Blitter Registers

| Register | Offset | Purpose |
|----------|--------|---------|
| BLTCON0 | $040 | Control + shift A |
| BLTCON1 | $042 | Control + shift B |
| BLTAFWM | $044 | First word mask A |
| BLTALWM | $046 | Last word mask A |
| BLTCPTH/L | $048/4A | Channel C pointer |
| BLTBPTH/L | $04C/4E | Channel B pointer |
| BLTAPTH/L | $050/52 | Channel A pointer |
| BLTDPTH/L | $054/56 | Channel D pointer |
| BLTSIZE | $058 | Starts blit (height + width) |
| BLTCMOD | $060 | C modulo |
| BLTBMOD | $062 | B modulo |
| BLTAMOD | $064 | A modulo |
| BLTDMOD | $066 | D modulo |

### Waiting for the Blitter

The Blitter runs in parallel with the CPU. Before starting a new blit or reading results, we must wait:

<CodeFromFile src="commodore-amiga/game-01-signal/unit-04/snippets/01-the-blitter.asm" lang="asm" />

## A Simple Car

For now, we'll draw a solid rectangular car. It's 16 pixels wide (1 word) and 8 pixels tall.

<CodeFromFile src="commodore-amiga/game-01-signal/unit-04/snippets/02-a-simple-car.asm" lang="asm" />

We'll draw this in colour 1 (first bitplane set, second clear).

### Drawing with the Blitter

To draw the car at position (X, Y):

1. Calculate destination address: `screen + Y*40 + X/8`
2. Set up source (car graphics)
3. Set modulos (bytes to skip between lines)
4. Set size and trigger

<CodeFromFile src="commodore-amiga/game-01-signal/unit-04/snippets/03-a-simple-car.asm" lang="asm" />

The BLTSIZE format is `(height << 6) | width_in_words`.

## Palette Setup

We need colours for our bitplane graphics. Colour 0 will be transparent (showing through to copper background). Colour 1 is the car:

<CodeFromFile src="commodore-amiga/game-01-signal/unit-04/snippets/04-palette-setup.asm" lang="asm" />

## Build It. Run It.

```bash
vasmm68k_mot -Fhunkexe -kick1hunks -o hop -nosym hop.asm
xdftool hop.adf create + format "Hop" ofs + boot install boot1x + write hop + makedir s
echo "hop" > startup-sequence
xdftool hop.adf write startup-sequence s/startup-sequence
fs-uae --floppy_drive_0=hop.adf
```

You should see the coloured lanes, the frog sprite, and a red car rectangle on the road!

## What You've Learnt

- **Bitplanes** store screen data in separate bit layers
- **BPLCON0** controls how many planes are active
- **The Blitter** copies rectangular blocks faster than the CPU
- **Minterms** define the boolean logic for combining channels
- **BLTSIZE** triggers the operation (format: `height << 6 | width`)
- **wait_blit** is essential before any blitter operation

## The Complete Code

Here's the full `hop.asm` with bitplanes and the Blitter:

<CodeFromFile src="commodore-amiga/game-01-signal/unit-04/hop.asm" lang="asm" />

## Recap / Sanity Check

Before moving on, verify:

- [ ] Build succeeds with no errors
- [ ] Coloured zones still display correctly
- [ ] Frog sprite still moves with joystick
- [ ] Red car rectangle visible on the road
- [ ] Car moves from left to right
- [ ] Car wraps back to left edge when it exits right

## Next Unit

One car is a start. A highway needs more.

In [Unit 5: Traffic Flow](/commodore-amiga/game-01-signal/unit-05), we'll add multiple cars in different lanes, moving at different speeds.
